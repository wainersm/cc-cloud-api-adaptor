name: test-e2e
on: [pull_request]

jobs:
  test-e2e-libvirt:
    name: libvirt
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        podvm-os:
          # Please keep this list in alphabetical order.
          #- centos
          - ubuntu
        include:
          #- os: centos
          #  dockerfile: Dockerfile.podvm_builder.centos
          - podvm-os: ubuntu
            dockerfile_builder: Dockerfile.podvm_builder
            dockerfile: Dockerfile.podvm
        runner:
          - ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Github container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build the podvm builder
      uses: docker/build-push-action@v3
      with:
        tags: |
          ghcr.io/${{ github.repository_owner }}/ci-podvm-builder-${{ matrix.podvm-os }}:${{ github.event.number  }}
        push: true
        context: podvm
        platforms: linux/amd64
        #cache-to: type=local,dest=/tmp/.buildx-cache,mode=max
        file: |
          podvm/${{ matrix.dockerfile_builder }}
        build-args: |
          "CAA_SRC=https://github.com/${{ github.repository }}.git"
          "CAA_SRC_REF=${{ github.ref }}"
    - name: Build the podvm image
      uses: docker/build-push-action@v3
      with:
        tags: |
          podvm-${{ matrix.podvm-os }}-libvirt:${{ github.event.number }}
        push: false
        load:true
        context: podvm
        platforms: linux/amd64
        #cache-from: type=local,dest=/tmp/.buildx-cache,mode=max
        file: |
          podvm/${{ matrix.dockerfile }}
        build-args: |
          "CLOUD_PROVIDER=libvirt"
          "BUILDER_IMG=ghcr.io/${{ github.repository_owner }}/ci-podvm-builder-${{ matrix.podvm-os }}:${{ github.event.number }}"
    - name: Extract the podvm qcow2
      run: ./hack/download-image.sh podvm-${{ matrix.podvm-os }}-libvirt:${{ github.event.number }} . -o podvm-${{ matrix.podvm-os }}-libvirt  
      working-directory: podvm